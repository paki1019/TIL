# 마이크로서비스 통신 패턴

## 동기 통신 방식

- 클라이언트에서 서버 측에 존재하는 마이크로서비스 REST API를 호출할 때 사용되는 기본 통신 방법.
- 다양한 클라이언트 채널 연계나 라우팅 및 로드 밸런싱을 원활하게 하기 위한 방법으로 중간에 API 게이트웨이를 둘 수 있다.
  ![프런트엔드에서 백엔드 호출](https://engineering-skcc.github.io/assets/images/msa/MSA3.4.png)
- 백엔드 마이크로서비스 간의 호출의 경우, 호출을 받은 마이크로서비스에 장애가 생긴다면, 요청을 보낸 서비스는 반응이 올 때까지 기다리게 되고, 반응이 오지 않으면 계속 기다리면서 재호출하게 됨.
  ![동기 통신](https://engineering-skcc.github.io/assets/images/msa/MSA3.5.png)
- 여러 서비스 간의 연계를 통해 업무를 처리하는 마이크로서비스 구조에서는 이 같은 상황에서 장애가 연쇄적으로 발생할 수 있음. 또한 서비스가 다른 서비스를 호출해서 얻은 정보를 이용해 기능을 제공하는 방식은, 서비스 간의 의존관계가 높다는 것을 의미함.

## 비동기 통신 방식

- 메시지 기반의 비동기(asynchronous) 호출 통신
  ![비동기 통신](https://engineering-skcc.github.io/assets/images/msa/MSA3.6.png)
- 메시지를 보낸 다음 응답을 기다리지 않고 다음 일을 처리함.
- 보낸 결과에 대한 응답을 받지 않으므로 동기식처럼 완결성을 보장할 수는 없음, 대신 이를 아파치 카프카(Apache Kafka), 래빗엠큐(RabbitMQ), 액티브엠큐(ActiveMQ) 같은 메시지 브로커(message broker)를 활용하여 보완함.
- 이러한 메커니즘에서는 메시지를 보내는 생산자(producer)와 메시지를 가져다가 처리하는 소비자(consumer)가 서로 접속하지 않고 메시지 브로커에 연결됨. 메시지 브로커는 메시지를 전달하여 전송을 보장함. 메시지 브로커는 메시지 처리 규모에 따라 확장 가능함.
- 이 방식은 메시지 브로커에 의해 중계되기 때문에 서로 통신하는 서비스들이 물리적으로 동일한 시스템에 위치할 필요도 없고 서로 프로세스를 공유할 필요도 없으며, 심지어 동일한 시간대에 동시에 동작하지 않아도 됨. 서비스 요구에 따라 늘어나거나 줄어들 수 있는 탄력성이 높은 클라우드 플랫폼 환경에서 서비스가 다운됐을 때 또는 시스템을 더 확장해야 할 때 사용할 수 있는 효과적인 방법.
- 클라우드 벤더에서 완전 관리형으로 제공하는 AWS의 SQS나 SNS, Azure Event Hub, Azure Event Grid 등도 많이 사용됨.

### 비동기 방식의 이벤트 기반 아키텍처

- 이벤트 기반 아키텍처는 분산 시스템 간에 발신자가 이벤트를 생성 및 발행(publish)하고, 해당 이벤트를 필요로 하는 수신자에게 전송하면 이벤트를 구독(subscribe)하고 있던 수신자에게 이벤트를 받아 처리하는 형태의 시스템 아키텍처.
  ![이벤트 기반 아키텍처의 개념도](https://engineering-skcc.github.io/assets/images/msa/MSA3.7.png)
- 커피숍에서 손님이 주문을 하면 주문 접수자는 주문을 받음. 그리고 바리스타에게 커피 제작을 의뢰함. 이때 주문 접수자는 하나의 주문이 바리스타에 의해 완료될 때까지 마냥 주문을 받지 않고 기다리지는 않음. 주문 접수 -> 커피 제작 -> 고객 전달이라는 하나의 무결하고 완결된 단위로 다루지 않음.
- 그 대신 주문이 들어오는 대로 꾸준히 주문 목록에 적고 동시에 커피 주문이 들어왔다는 이벤트를 바리스타에게 계속 전달함. 그럼 바리스타도 마찬가지로 커피 주문 이벤트를 순차적으로 제작 목록에 기입하고 주문에 해당하는 커피를 만듬. 그리고 커피 제작이 완료되면 커피 제작 완료 이벤트를 보내고, 이것이 진동벨을 통해 손님에게 통보됨.
- 이러한 이벤트 기반 방식은 여러 개의 주문을 받아 여러 개의 커피를 동시에 제작할 수 있는 효율성을 높임.
- 이처럼 이벤트 기반 아키텍처는 이벤트를 생산하는 모듈과 이벤트에 대응하는 모듈을 분리하고 상호 독립적으로 동작하게 함으로써 병렬 처리를 촉진함.
