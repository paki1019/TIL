# 구성 관리

## 외부 구성 저장소 패턴

- 마이크로서비스가 사용하는 자원의 설정 정보를 쉽고 일관되게 변경 가능하도록 관리할 필요가 있음.
- 외부 저장소 패턴은, 각 마이크로서비스의 설정 정보를 외부 저장소에 백업해두는 것.
- 데이터베이스 연결 정보, 배포 시 변경해야할 호스트명, 백엔드 서비스 연결을 위한 리소스 정보 등과 같이 특정 배포 환경에 종속된 정보는 배포 환경이 변경됐을 때 애플리케이션 또한 변경해야 하기 때문에 코드에서 분리해서 환경 변수로 관리해야 함.
- 스프링 클라우드 컨피그(Spring Cloud Config)를 이용하면 이러한 환경 정보를 코드에서 분리하고 컨피그 서비스를 통해 런타임 시 주입되게 할 수 있다.
- 쿠버네티스에서는 이러한 외부 구성 저장소 패턴을 쿠버네티스 컨피그맵(ConfigMap)으로 제공함.

![스프링 클라우드 컨피그](https://engineering-skcc.github.io/assets/images/MSA2.18.png)

## 클라우드 기반의 마이크로서비스 개발에서 중요한 3가지

클라우드 기반의 마이크로서비스 개발에서는 다음 사항이 강조됨.

1. 배포되는 실제 코드에서 애플리케이션의 구성을 완전하게 분리.
2. 서버 및 애플리케이션을 빌드하고 배포 환경에 따라 절대 바뀌지 않는 불변 이미지 빌드.
3. 서버를 시작할 때 환경 변수나 애플리케이션의 마이크로서비스가 읽어 올 수 있는 중앙 저장소를 이용해 애플리케이션 구성 정보 주입.

## 구성(그리고 복잡성) 관리

마이크로서비스의 인스턴스는 사람이 최소한으로 개입해 신속하게 시작해야 하므로 클라우드에서 실행되는 마이크로서비스에 애플리케이션 구성 관리는 매우 중요. 사람이 수동으로 구성하거나 배포하면 구성 편차(configuration drift)와 예상하지 못한 장애, 애플리케이션 확장 요구에 대한 지체 시간(lag-time)이 발생할 수 있음.

구성 관리를 위한 네 가지 원칙

1. 분리(segregate): 실제 물리적인 서비스의 배포와 서비스 구성 정보를 완전히 분리. 애플리케이션 구성 정보를 서비스 인스턴스와 함께 배포하면 안됨. 서비스에 환경 변수로 전달하거나 중앙 저장소에서 읽어 와 구성 정보를 전달.
2. 추상화(abstract): 서비스 저장소에 직접 엑세스하는 코드를 작성하기(즉, JDBC를 사용해 데이터베이스에서 데이터 읽기)보다 애플리케이션이 REST 기반의 JSON 서비스를 사용해 구성 데이터를 조회하게 만들어야함.
3. 중앙 집중화(centralize): 구성 정보를 보관하는 저장소 개수를 최소화.
4. 견고성(harden): 어떤 솔루션을 사용하더라도 고가용성과 다중성을 구현할 수 있어야 함.

즉 구성 정보를 실제 코드 외부로 분리해서 버전 제어를 하면서 관리.

## 구성 관리 아키텍처

마이크로서비스를 위한 구성 관리는 마이크로서비스의 부트스트래핑 단계에서 일어남.
![서비스 부트스트래핑 단계에서 애플리케이션 구성 데이터를 읽음](https://thebook.io/img/006962/100.jpg)

![구성 관리의 개념적 아키텍처](https://thebook.io/img/006962/101.jpg)

1. 마이크로서비스 인스턴스가 시작하면 서비스 엔드포인트를 호출해 동작 중인 환경별 구성 정보를 읽어 옴.
2. 실제 구성 정보는 저장소에 상주. 소스 관리되는 파일이나 관계형 데이터베이스, 키-값 짝 데이터 저장소 같은 구현 방식을 선택할 수도 있음.
3. 애플리케이션 배포 방식과 독립적으로 애플리케이션 구성 데이터를 관리. 대개 밸드 및 배포 파이프라인으로 구성 관리를 변경하며 변경된 구성은 버전 정보 태그(tag)를 달아 다른 환경에 배포될 수 있게 함.
4. 구성 관리가 변경되면 애플리케이션 구성 데이터를 사용하는 서비스는 변경 통보를 받고 보유한 애플리케이션 데이터 사본을 갱신함.

## 예시

https://github.com/gilbutITbook/006962/tree/master/config-repo
