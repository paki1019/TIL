# 마이크로서비스 데스옵스

데브옵스 관점에서 마이크로서비스 네 가지 원칙.

1. 마이크로서비스는 단일 소프트웨어 산출물(artifact)을 사용해 여러 서비스 인스턴스를 시작하거나 제거할 수 있도록 자체 완비형(self-contained)이며 독립적으로 배포 가능(independently deployable)해야 함.
2. 마이크로서비스는 구성 가능(configurable)해야 함. 서비스 인스턴스가 시작될 때 구성에 필요한 데이터를 중앙에서 읽어 들이거나 환경 변수로 전달된 구성 정보를 받아야 함. 이 과정에서 사람의 개입은 불필요해야함.
3. 마이크로서비스 인스턴스는 클라이언트가 위치를 알지 못하도록 투명해야(transparent) 함. 클라이언트는 서비스의 정확한 위치를 알고 있어서는 안 되며, 마이크로서비스 클라이언트는 마이크로서비스 인스턴스의 물리적 위치를 모르더라도 애플리케이션이 알 수 있도록 서비스 디스커버리 에이전트(service discovery agent)와 통신해야 함.
4. 마이크로서비스는 자신의 상태(health)를 전달해야 함. 마이크로서비스 인스턴스들은 고장 날 수 잇으며 클라이언트는 잘못된 서비스 인스턴스를 피해 라우팅해야 함.

위 네 가지 원칙은 다음 운영상의 수명 주기 단계로 대응됨.

- 서비스 어셈블리(service assembly): 동일한 서비스 코드와 런타임을 정확히 같은 방식으로 배포하기 위해 반복성과 일관성을 보장하는 서비스 패키징과 배포 방식.
- 서비스 부트스트래핑(service bootstrapping): 사람이 개입하지 않아도 모든 환경에 마이크로서비스 인스턴스를 신속하게 시작하고 배포하기 위해 애플리케이션과 환경별 구성 코드를 런타임 코드와 분리하는 방법.
- 서비스 등록 및 디스커버리(service registration/discovery): 새로운 마이크로서비스 인스턴스가 배포될 때 다른 애플리케이션 클라이언트가 발견할 수 있게 만드는 방법.
- 서비스 모니터링(service monitoring): 마이크로서비스 인스턴스를 모니터링하고 마이크로서비스 고장을 회피하는 라우팅과 비정상 서비스 인스턴스를 제거.

![마이크로서비스가 시작되면 서비스 수명 주기의 여러 단계를 거침](https://thebook.io/img/006962/087.jpg)

## 서비스 어셈블리: 마이크로서비스 패키징과 배포

```
1. 마이크로서비스는 단일 소프트웨어 산출물(artifact)을 사용해 여러 서비스 인스턴스를 시작하거나 제거할 수 있도록 자체 완비형(self-contained)이며 독립적으로 배포 가능(independently deployable)해야 함.
```

이 개념을 충족하기 위해 마이크로서비스는 필요한 의존성을 모두 담아 단일 산출물로 패키징하고 배포될 수 있어야 함. 이러한 의존성에는 마이크로서비스를 호스팅하는 런타임 엔진도 포함됨.

![서비스 어셈블리 단계에서 소스 코드를 컴파일하고 런타임 엔진과 함께 패키징](https://thebook.io/img/006962/089.jpg)

많은 조직에서 애플리케이션 서버의 구성을 소스 제어 저장소에 보관하지 않고 사용자 인터페이스와 자체 제작한 스크립트를 사용해 관리하는데, 이 경우 구성 편차(configuration drift)가 말생하여 문제점이 발생함.

이를 방지하기 위해 내장형 런타임 엔진을 포함한 단일 산출물로 배포할 필요성이 있음.

## 서비스 부트스트래핑: 마이크로서비스의 구성 관리

마이크로서비스가 처음 가동할 때 애플리케이션 구성 정보를 로드(load) 하는 것.

![서비스가 시작할 때(부트스트랩), 서비스는 중앙의 구성 저장소에서 구성 정보를 읽어옴](https://thebook.io/img/006962/091.jpg)

구성 데이터는 구조가 단순한 편이고 자주 조회하지만 자주 수어되지는 않음. 따라서 관계형 데이터베이스보단 키-값 데이터 저장소를 사용하는것이 적절함.

## 서비스 등록과 디스커버리: 클라이언트가 마이크로서비스와 통신하는 방법

클라우드 기반 환경에서 서버는 일시적이기 때문에 마이크로서비스는 소비자 관점에서 위치 투명성을 가져야 함.

모든 서비스에는 고유하고 비영구적인 IP 주소가 할당됨.

마이크로서비스 인스턴스는 서비스 디스커버리(service discovery)에 물리적인 IP 주소 또는 도메인 주소와 애플리케이션 서비스 검색에 사용할 논리적인 서비스 이름을 전달. 추가적으로 상태 확인(health check)를 위한 URL을 전달하기도 함.

![서비스 디스커버리 에이전트는 서비스의 물리적 위치를 추상화함](https://thebook.io/img/006962/092.jpg)

## 마이크로서비스의 상태 전달

서비스 디스커버리는 등록된 각 서비스의 상태도 모니터링함. 등록된 서비스 인스턴스가 고장날 경우, 클라이언트가 고장 난 서비스를 호출하지 않도록 자신의 라우팅 테이블에서 문제의 서비스 인스턴스를 제거함.

![서비스 디스커버리 에이전트는 노출된 URL을 사용해 마이크로서비스 상태를 확인](https://thebook.io/img/006962/093.jpg)

마이크로서비스가 실행되면 서비스 디스커버리 에이전트는 해당 서비스가 가용한지 확인하기 위해 상태 확인 인터페이스(health chcek interface)를 계속 모니터링하고 핑(ping)함.

REST 기반 마이크로서비스 환경에서는 JSON 페이로드와 HTTP 상태 코드를 반환하는 HTTP 엔드포인트를 통해 상태 확인 인터페이스를 제공하곤 함.
