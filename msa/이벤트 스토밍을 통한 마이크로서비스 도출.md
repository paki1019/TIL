# 이벤트 스토밍을 통한 마이크로서비스 도출.

- 이벤트 스토밍(event storming)은 이벤트 중심으로 이해관계자들이 모여 브레인 스토밍하는 워크숍을 의미.
- 모든 이해관계자가 모여 서로가 가지고 있는 각 관점을 논의하며, 그 차이점을 이해하고 공유할 수 있다는 점에서 기존 방법론에서 장기간 단절하며 수행했던 요구사항, 프로세스 모델링, 설계를 진행하는 과정을 뛰어넘는 민첩성과 효율성을 보여줌. 또한 쉽고 간편한 도구를 사용해 빠른 시간 내에 지식 공유를 통한 협업을 가속화하고 시각화함으로써 서로간의 학습 및 탐색을 촉진하는 워크숍이라 할 수 있음.

## 이벤트 스토밍 워크숍 준비

### 워크숍 준비

- 공간: 깨끗한 벽이 있는 넓은 워크숍 공간
- 참가자: 고객, 도메인 전문가, 설계자, 개발자, 테스트 등 모든 이해관계자
- 준비물: 벽에 붙일 흰색 A0 전지, 마커 펜, 다양한 색의 스티커, 선을 만들 수 있는 다양한 색깔의 라인 테이프, 스카치 테이프
- 열린 분위기로 활동을 촉진하고 리딩할 수 있는 퍼실리테이터(facilitator)

![이벤트 스토밍 사례1](https://engineering-skcc.github.io/assets/images/msa/MSA5.12_1.png)
![이벤트 스토밍 사례2](https://engineering-skcc.github.io/assets/images/msa/MSA5.12_2.jpeg)

### 워크숍 방식

1. 넓은 공간(벽이나 넓은 책상)에 여러 장의 흰색 전지를 이어 붙여 설계 공간을 마련.
2. 쉽게 접근 가능한 별도 공간에 다양한 색의 포스트잇과 기타 준비물을 오려 놓음.
3. 모든 참가자가 마커펜을 하나씩 들고 설계 공간을 바라보게 함.
4. 퍼실리테이터의 지시에 따라 워크숍을 진행. 모든 활동은 타임박싱으로 집중해서 몰입하도록 유도.

### 스티커 유형별 의미

![스티커의 색상별 유형](https://engineering-skcc.github.io/assets/images/msa/MSA5.12_3.png)

| 유형              | 색깔        | 설명                                                             |
| ----------------- | ----------- | ---------------------------------------------------------------- |
| 도메인이벤트      | 오렌지색    | 발생된 사건, 과거시제동사로 표현                                 |
| 커맨드            | 파란색      | 이벤트를 트리거하는 명령                                         |
| 외부 시스템       | 핑크색      | 이벤트가 호출하거나 관계가 있는 레거시 또는 외부 시스템, 장비    |
| 액터              | 작은 노란색 | 개인 또는 조직의 역할                                            |
| 애그리거트        | 노란색      | 도메인 이벤트와 커맨드가 처리하는 데이터, 상태가 변경되는 데이터 |
| 정책              | 라일락 색   | 이벤트 조건에 따라 진행되는 결정 When [이벤트]then [커맨드]      |
| 읽기 모델         | 초록색      | 도메인 이벤트 액터에게 제공되는 데이터                           |
| 사용자 인터페이스 | 흰색        | 스케치 형태의 화면 레이아웃                                      |
| 핫스팟(Hot spot)  | 보라 색     | 의문, 질문, 미결정 사항                                          |

## 이벤트 스토밍 워크숍 진행

### 이벤트 스토밍은 다음과 같은 순서로 진행

1. 도메인 이벤트 찾기
2. 외부 시스템/외부 프로세스 찾기
3. 커맨드 찾기
4. 핫스폿 찾기
5. 액터(사용자/역할) 찾기
6. 애그리거트 정의하기
7. 바운디드 컨텍스트 정의하기
8. 컨텍스트 매핑하기

### 도메인 이벤트 찾기

- 시간의 흐름에 따라 시스템의 동작을 의미하는 도메인 이벤트를 도출.
- 데이터나 데이터의 구조가 아닌 비즈니스 흐름에서 발생한 이벤트에 초점을 두는 것이 중요.
- 오렌지색 포스트잇에 이벤트명을 작성해서 붙임, 이벤트명은 과거형 동사.
- 이벤트는 왼쪽에서 오른쪽으로 시간 흐름순으로 붙이되 이벤트가 연쇄적으로 발생하는 경우 바로 옆에 붙임. 같은 시점에 비즈니스 조건에 따라 대체적으로 발생할 수 있는 이벤트는 세로로 아래쪽에 같은 선상에 붙임.
- 도메인 이벤트는 비즈니스의 어떤 상태를 생성, 변경, 삭제하는 요소. 시스템의 화면을 연상하지 말고 비즈니스가 흘러감에 따라 비즈니스를 구성하는 요소들의 상태가 어떻게 변경되는지 생각.

![도메인 이벤트 찾기](https://engineering-skcc.github.io/assets/images/msa/MSA5.13.png)

### 외부 시스템 도출

- 레거시 시스템이나 외부 시스템과의 연계를 통해 업무의 흐름이 진행될 때 이 프로세스의 이름을 핑크색 스티커에 작성해서 오른쪽 상단에 붙이고 화살표를 그려 이 외부 시스템을 호출한다는 것을 표시.
- 시스템 구현 범위에 있는 기능이 아니더라도 시스템의 기능 구현을 위해 연계가 필요한 시스템들은 모두 도출.
- 시스템을 명사 형태로 적음.
  ![외부 시스템 도출](https://engineering-skcc.github.io/assets/images/msa/MSA5.15.png)

### 커맨드 도출

- 도메인 이벤트를 찾은 후, 이 이벤트를 동작하게 하는 커맨드(Command)를 찾음. 커맨드는 파란색 포스트잇에 작성.
- 커멘드명은 도메인 이벤트를 동작하게 하는 것으로 명령형으로 작성.
- 하나의 커맨드에 의해 여러 개의 이벤트가 동시에 또는 연속으로 발생할 수 있음.

![커맨드 도출](https://engineering-skcc.github.io/assets/images/msa/MSA5.14.png)

### 핫스폿 도출

- 워크숍을 진행하는 과정에서 의문 사항이 생기거나 참여하는 사람들이 결정하기 힘든 사항, 다른 부서나 외부에 문의할 필요가 있는 사항과 같이 워크숍 중에 해결하거나 정의할 수 없는 것들. 이러한 내용을 보라색 스티커에 가정, 경고, 질문, 미결정 사항 등을 작성해 문제가 되는 위치에 붙임.

### 액터 도출

- 커맨드를 실행하는 액터(Actor)를 도출. 액터는 사용자 또는 조직, 역할자를 의미.
- 액터는 추상적으로 식별하지 않고 비즈니스를 수행하는 구체적인 역할을 고려해서 도출. 특정 비즈니스를 실제로 수행하는 판매자, 구매자, 상품 관리자, 배송 관리자, 시스템 관리자와 같이 명확한 역할자를 도출하려고 노력.
- 액터를 도출하면서 이전에 식별하지 못했던 커맨드와 도메인 이벤트가 추가로 도출돌 수 있음.

![액터 도출](https://engineering-skcc.github.io/assets/images/msa/MSA5.16.png)

### 애그리거트 정의

- 애그리거트는 커맨드와 도메인 이벤트가 영향을 주는 요소로, 도메인의 실체 개념을 표현하는 객체인 엔티티가 됨.
- 노란색 포스트잇에 애그리거트명을 작성해서 커맨드와 도메인 이벤트 사이에 겹쳐서 붙임.

![애그리거트 정의](https://engineering-skcc.github.io/assets/images/msa/MSA5.17.png)

### 바운디드 컨텍스트 그리기

- 일부 애그리거트는 이름이 같거나 유사함. 이처럼 이름이 같거나 유사한 애그리거트를 완전히 다른 애그리거트와 구분해서 경계를 그림. 또한 그동안 도출했던 도메인 이벤트, 커맨드, 액터, 애그리거트를 모두 고려해서 경계를 식별.
- 이 경계를 바운디드 컨텍스트라고 함. 컨텍스트의 이름은 바운디드 컨텍스트 내의 애그리거트 이름으로 정의. 여러 개의 애그리거트의 이름이 있는 경우 대표 이름으로 정함.
- 동일한 이름의 애그리거트가 서로 다른 공간에 떨어져 있는 경우, 많이 식별된 위치로 포스트잇을 옮김.

![바운디드 컨텍스트 그리기](https://engineering-skcc.github.io/assets/images/msa/MSA5.18.png)

### 정책을 도출하면서 연관관계 생각하기

- 정책은 이벤트 뒤에 따라오는 반응적인 비즈니스 로직으로, 어딘가에 존재하는 커맨드를 동작하게 함.
- 정책은 다음과 같이 정의함. `[도메인 이벤트]할 때는 항상 [커맨드]한다.`
- 정책은 라일락색 포스트잇을 사용.
- 정책은 도메인 이벤트와 커맨드 사이에 존재하며, 같은 바운디드 컨텍스트 내에 존재할 수도 있고, 다른 바운디드 컨텍스트에 존재할 수도 있다.
- 정책을 도출함으로써 다른 바운디드 컨텍스트와의 관계를 식별할 수 있음.

![정책 도출 및 연관관계 정의](https://engineering-skcc.github.io/assets/images/msa/MSA5.19.png)

### 컨텍스트 매핑

- 앞의 과정까지 진행해서 대략의 바운디드 컨텍스트가 식별되고 각 바운디드 컨텍스트 간의 관계가 파악됨. 이러한 관계를 별도의 컨텍스트 맵으로 표현.
- 컨텍스트 관계를 작성할 때는 호출 관계의 방향을 고려. 또한 호출할 때 동기/비동기 방식의 호출 방식 또한 고려.
- 호출 방식은 데이터의 일관성 측면과 컨텍스트의 가용성 측면을 고려해서 선택. 결과적 일관성으로 충분히 처리 가능한 관계는 비동기 방식의 호출로 표현.
- 일반적으로 동기 방식은 실시간 동시 처리를 위해 호출하고 응답을 대기하는 방식으로, 두 컨텍스트 간의 의존도가 높아짐.
- 비동기 방식은 컨텍스트 내에서 처리한 후 이벤트를 발행해 연관된 다른 컨텍스트가 이벤트를 받아 처리할 수 있게 하는 방식으로 두 컨텍스트 간의 의존성을 낮출 수 있음.
- 반드시 실시간 정합성이 필요한 경우가 아니라면 비동기 방식의 연계로 두 컨텍스트 사이의 결합도를 낮춰 독립성과 탄력성을 강화하는 것이 좋음.
- 컨텍스트 맵은 이벤트 스토밍 워크숍에서 식별한 바운디드 컨텍스트명을 스티커에 적어 별도 공간에 붙이고 관계를 표현하면 됨. 동기 호출은 실선으로, 비동기 호출은 점선으로 표현.

![바운디드 컨텍스트 간 매핑 관계](https://engineering-skcc.github.io/assets/images/msa/MSA5.20.png)

- 최근에는 비동기 연계를 위한 메시지 브로커의 성능과 안정성이 높아져서 동기 방시의 연동은 꼭 필요한 경우에만 사용하고 많은 부분에 비동기 연동을 통해 데이터 정합성을 맞추는 경우가 많아짐.
- 비동기 연동 방식은 동기 연동 방식에 비해 마이크로서비스가 독립성을 갖게 하고 높은 가용성을 보장 받을 수 있게 함.
- 이렇게 도출된 바운디드 컨텍스트는 마이크로서비스 후보가 됨. 다음과 같은 질문을 고려해서 최종 판단함.
  - (비즈니스 측면) 비즈니스 프로세스를 수행하기 위한 하나의 맥락의 단위로 구분될 수 있는가?
  - (데이터 관점) 마이크로서비스별로 분리된 데이터를 정의할 수 있는가?
  - (운영 조직 측면) 하나의 팀이 독립적으로 운영 가능한 단위인가?
  - (배포 측면) 독립적으로 배포 가능한 단위인가?
  - (변경 영향도) 변경 시 영향을 받는 마이크로서비스가 존재하는가?
  - (클라우드/MSA 도입 목적 측면) 도입을 통한 기대효과를 충분히 활용할 수 있는가?
- 이를 모두 만족한다면 바운디드 컨텍스트를 최종 마이크로서비스로 식별하고, 만족하지 못한다면 각 질문의 결과에 따라 바운디드 컨텍스트를 분리하거나 통합해서 마이크로서비스로 식별.

### 마이크로서비스 상세 설계를 위한 입력물

- 이벤트 스토밍 결과는 서비스 상세 설계를 위한 출발점이 됨.
- 마이크로서비스별로 커맨드, 도메인 이벤트, 애그리거트, 서비스 연계 및 정책, 핫스팟, API, 데이터, 리스크 등으로 정리할 수 있으며, 마이크로서비스의 프런트엔드 모델링과 백엔드 모델링에 활용됨.

![마이크로서비스 상세 설계를 위한 입력물](https://engineering-skcc.github.io/assets/images/msa/MSA5.21.png)
