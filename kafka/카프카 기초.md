# 메시지 송수신 기본

![카프카 개요도](https://baek.dev/assets/images/post/2020/2020_020_005.jpg)

카프카의 주요 구성 요소

- 브로커
  - 데이터를 수신, 전달하는 서비스
- 메시지
  - 카프카에서 다루는 데이터의 최소 단위, 카프카가 중계하는 로그의 한 줄 한 줄과 센서 데이터 등이 이에 해당. 메시지는 Key와 Value를 갖게 되며 메시지 전송할 때 파티셔닝에 이용.
- 프로듀서
  - 데이터의 생산자이며 브로커에 메시지를 보내는 애플리케이션.
- 컨슈머
  - 브로커에서 메시지를 취득하는 애플리케이션.
- 토픽
  - 메시지를 종류(토픽)별로 관리하는 스토리지, 브로커에 배치되며 관리됨. 프로듀서와 컨슈머는 특정 토픽을 지정하여 메시지를 송수신함으로써 단일 카프카 클러스터에서 여러 종류의 메시지를 중계함.

# 시스템 구성

이러한 구성 요소를 동작시키는 데 필요한 시스템 구성.

## 브로커

하나의 서버(인스턴스) 당 하나의 데몬 프로세스로 동작하여 메시지 수신/전달 요청을 받아들임. 이것을 여러 대의 클러스터로 구성할 수 있으며 브로커(리소스)를 추가함으로써 수신/전달의 처리량 향상(스케일 아웃)이 가능함.

브로커에서 받은 데이터는 모두 디스크로 내보내기(영속화)가 이루어져 디스크의 총 용량에 따라 장기간 데이터를 보존할 수 있음.

## 프로듀서 API/컨슈머 API

프로듀서/컨슈머를 구현하는 기능은 브로커로 데이터를 보내고 브로커에서 데이터를 받기 위한 '라이브러리'로 제공됨. 프로듀서, 컨슈머는 브로커처럼 서비스(데몬 프로세스)로 작동하는 프로그램이 아니다. 각각의 API는 자바로 제공됨.

## 프로듀서

프로듀서 API를 이용해서 브로커에 데이터를 송신하기 위해 구현된 애플리케이션.

실제로 프로듀서 기능을 개장하거나 서드 파티의 플러그인 제휴를 통해 제공하는 OSS(Open Source Software)

- Apache Log4j(Kafka Appender)
  - 로그 출력 시 사용하는 자바 기반 로깅 유틸리티 소프트웨어
- Apache Flume
  - 다량의 로그 데이터를 효율적으로 수집, 취합, 이동하기 위한 분산형 소프트웨어
- Fluented
  - 크로스 플랫폼 오픈소스 데이터 수집 소프트웨어
- Logstash
  - 엘라스틱에서 제공하는 OSS 데이터 수집 엔진

## 컨슈머

컨슈머 API를 이용해 브로커에서 메시지를 취득하도록 구현된 애플리케이션. 브로커에 메시지를 디스크에 영속화하기 때문에 디스크에 보관되어 있는 동안은 메시지 취득이 가능함.

프로듀서와 마찬가지로 카프카 연계를 위한 컨슈머 기능을 갖춘 기존 제품도 많이 존재.

- Apache Spark
  - 빅데이터 처리를 위한 오픈 소스 클러스터 컴퓨팅 프레임워크
- Apache Samza
  - 스트림 처리용 오픈소스 소프트웨어로 준 리얼타임 비동기 계산 프레임워크
- Apache Flink
  - 스트림 처리용 오픈소스 프레임워크
- Apache Flume
- Fluented
- Logstash

### PUSH형, PULL형

'프로듀서 -> 브로커'의 메시지 송신은 프로듀서가 주체가 되어 브로커에 전송하는 PUSH 형으로 이루어짐.
'브로커 -> 컨슈머'의 메시지 송신은 컨슈머에서의 패치 요청을 계기로 메시지가 송신됨. 즉, 브로커에서 볼 때 PULL 형.

## 주키퍼

카프카의 브로커는 분산 처리를 위한 관리 도구로 아파치 주키퍼(Apache ZooKeeper)가 필요. 주키퍼는 하둡 등 병렬 분산 처리용 OSS에 있어서 설정 관리, 이름 관리, 동기화를 위한 잠금 관리를 하는 구조로 자주 사용됨. 카프카에 있어서 분산 메시징의 메타데이터(토픽과 파티션 등)를 관리하기 위한 구성 요소로 기능.

## 카프카 클라이언트

토픽 작성 등 카프카의 동작 및 운영 상에 필요한 조작을 실행하는 서버. 메시지의 송수신을 처리하는 서버는 아님.

## 카프카 클러스터

카프카는 여러 대의 브로커 서버, 주키퍼 서버로 이루어진 클러스터링의 메시지 중계 기능과 메시지 송수신을 위한 라이브러리 그룹(Producer API/Consumer API)로 구성됨. 브로커, 주키퍼에 의해 구성된 클러스터 시스템을 카프카 클러스터라고 정의.
