# 카프카 브로커, 클러스터, 주키퍼

카프카 브로커는 카프카 클라이언트와 데이터를 주고받기 위해 사용하는 주체이자, 데이터를 분산 저장하여 장애가 발생하더라도 안전하게 사용할 수 있도록 도와주는 애플리케이션.

하나의 서버에 하나의 카프카 브로커 프로세스가 실행됨. 서버 1대로도 기본 기능이 실행되지만 데이터를 안전하게 보관하고 처리하기 위해 3대 이상의 브로커 서버를 1개의 클러스터로 묶어서 운영함.

카프카 클러스터로 묶인 브로커들은 프로듀서가 보낸 데이터를 안전하게 분산 저장하고 복제하는 역할을 수행.

## 데이터 저장, 전송

카프카 브로커는 프로듀서로부터 전달받은 데이터를 프로듀서가 요청한 토픽의 파티션에 저장, 컨슈머가 데이터를 요청하면 파티션에 저장된 데이터를 전달함.

프로듀서로부터 전달된 데이터는 파일 시스템에 저장됨.

카프카는 메모리나 데이터베이스를 사용하지 않으며 따로 캐시메모리를 구현하여 사용하지도 않음. 파일 시스템은 지속적으로 입출력할 경우 처리 속도가 느려지는 문제가 생길 수 있으나 카프카는 페이지 캐시(page cache)를 사용하여 디스크 입출력 속도를 높여서 이 문제를 해결함.

## 데이터 복제, 싱크

데이터 복제(replication)는 카프카를 장애 허용 시스템(fault tolerant system)으로 동작하도록 하는 원동력. 클러스터로 묶인 브로커 중 일부에 장애가 발생하더라도 데이터를 유실하지 않도록 데이터를 복제함.

카프카의 데이터 복제는 파티션 단위로 이루어짐. 토픽을 생성할 때 파티션의 복제 개수(replication factor)도 같이 설정. 복제 개수의 최솟값은 1(복제 없음), 최댓값은 브로커 개수만큼.

복제된 파티션은 리더(leader)와 팔로워(follower)로 구성. 프로듀서 또는 컨슈머와 직접 통신하는 파티션을 리더, 나머지 복제 데이터를 가지고 있는 파티션을 팔로워라고 부름. 팔로워 파티션은 리더 파티션의 오프셋을 확인하여 현재 자신이 가지고 있는 오프셋과 차이가 나는 경우 리더 파티션으로부터 데이터를 가져와서 자신의 파티션에 저장하는데 이것이 복제(replication).

파티션 복제로 인해 나머지 브로커에도 파티션의 데이터가 복제되므로 복제 개수만큼 저장 용량이 증가한다는 단점이 있음. 그러나 복제를 통해 데이터를 안전하게 사용할 수 있다는 점은 강력한 장점.

리더 파티션이 존재하는 브로커가 다운되는 경우 해당 브로커의 리더 파티션은 사용할 수 없기 때문에 팔로워 파티션 중 하나가 리더 파티션 지위를 넘겨받음.

## 컨트롤러(controller)

클러스터의 다수 브로커 중 한 대가 컨트롤러 역할을 함. 컨트롤러는 다른 브로커들의 상태를 체크하고 브로커가 클러스터에서 빠지는 경우 해당 브로커에 존재하는 리더 파티션을 재분배함.

컨트롤러 역할을 하는 브로커에 장애가 생기면 다른 브로커가 컨트롤러 역할을 함.

## 데이터 삭제

카프카는 다른 메시징 플랫폼과 다르게 컨슈머가 데이터를 가져가더라도 토픽의 데이터는 삭제되지 않으며, 컨슈머나 프로듀서가 데이터 삭제를 요청할 수도 없음. 오직 브로커만이 데이터 삭제 가능.

데이터 삭제는 파일 단위로 이루어지는데 이 단위를 로그 세그먼트(log segment)라고 부름. 세그먼트에는 다수의 데이터가 존재함.

세그먼트는 데이터가 쌓이는 동안 파일 시스템으로 열려있음. 세그먼트 파일이 닫히게 되는 기본값은 1GB 용량에 도달했을 때이며 log.segement.bytes 또는 log.segement.ms 옵션 설정값으로 설정 가능.

닫힌 세그먼트 파일은 log.retention.byte 또는 log.retention.ms 옵션 설정값이 넘으면 삭제됨.

## 컨슈머 오프셋 저장

컨슈머 그룹은 토픽이 특정 파티션으로부터 데이터를 가져가서 처리하고 이 파티션의 어느 레코드까지 가져갔는지 확인하기 위해 오프셋을 커밋함.
커밋한 오프셋은 \_\_consumer_offsets 토픽에 저장함. 여기에 저장된 오프셋을 토대로 컨슈머 그룹은 다음 레코드를 가져가서 처리함.

## 코디네이터(coordinator)

클러스터의 다수 브로커 중 한 대는 코디네이터의 역할을 수행함. 코디네이터는 컨슈머 그룹의 상태를 체크하고 파티션을 컨슈머와 매칭되도록 분배하는 역할을 함. 컨슈머가 컨슈머 그룹에서 빠지면 매칭되지 않은 파티션을 정상 동작하는 컨슈머로 할당하여 끊임없이 데이터가 처리되도록 도와줌. 이러한 컨슈머 재할당 과정을 리밸런스(rebalance)라고 부름.

## 카프카 클러스터를 운영할 때 주키퍼가 하는 역할

주키퍼는 카프카의 메타데이터를 관리하는 데 사용됨. 통신 보안 규칙, jmx port 상태 정보, host 정보, 컨트롤러 브로커, 저장된 토픽 등 여러 설정 정보를 확인 가능.

카프카 클러스터로 묶인 브로커들은 동일한 경로의 주키퍼 경로로 선언해야 같은 카프카 브로커 묶음이 됨. 카프카 클러스터를 여러 개로 운영하는 경우 한 개의 주키퍼에 다수의 클러스터를 연결해서 사용할 수도 있음.
