# Business Logic Vulnerability

로직상에 결함이 있어 개발자가 의도하지 않은 흐름을 사용하는 공격.

앞서 다룬 XSS, SQL Injection은 모든 응용 프로그램에 존재할 수 있는 공격 기법이지만, 로직의 결함이 있어서 발생하는 취약점은 프로그램마다 다른 형태를 가짐.

## 예시
예시로 소개드릴 취약점은 타인의 비밀번호를 변조하는 예시

```
POST http://NT11622.scc.svc.ad1.io.navercorp.com/users/update HTTP/1.1
Host: NT11622.scc.svc.ad1.io.navercorp.com
Connection: keep-alive
Content-Length: 75
Cache-Control: max-age=0
Origin: http://NT11622.scc.svc.ad1.io.navercorp.com
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Referer: http://NT11622.scc.svc.ad1.io.navercorp.com/users/updatePage
Accept-Encoding: gzip, deflate, br
Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7
Cookie: JSESSIONID=17E3F2CE84CFB5317390986E1A02705E

id=2&password=newpassword&password_check=newpassword
```
비밀번호 변경을 요청할 때 발생하는 HTTP Request. 여기서 주목해야할 파라미터는 id 입니다.(id의 값은 유저별로 다릅니다.) id는 현재 로그인한 유저의 key값으로 자신의 비밀번호 변경을 요청하는 패킷

```
@PostMapping("/update")
public String update(HttpServletRequest request, Principal principal, HttpSession session){

    Long id = Long.parseLong(request.getParameter("id"), 10);
    String password = request.getParameter("password");

    userService.updateUserPassword(id, password);

    return "users/passwordChanged";
}
```
유저의 요청을 처리하는 컨트롤러에서 유저가 요청한 id값의 유저의 비밀번호를 변경하게 됨. id 값은 별도의 검증없이 유저가 전송한 값을 사용함. 따라서 id 값을 변조하면 타인의 비밀번호를 변경할 수 있음.

## 영향력
비즈니스 로직 취약점의 영향력은 개발된 프로그램의 성격에 따라 결정됩니다. 중요도가 높은 로직을 처리하는 부분에 결함이 생겨 의도하지 않는 대로 실행되는 경우, 중요도가 높게 평가됨.

## 대응방안
### 1. 권한 검증은 모든 단계에서 수행
유저의 권한이 요구되는 기능의 경우 모든 단계에서 수행해야함. 유저의 요청이 순차적으로 실행될것이라 착각하여 첫번째 단계에서 검증 후 다음 단계에서 검증하지 않는 경우에 권한을 우회하는 취약점이 발생할 수 있음.

### 2. 사용자 입력값 신뢰하지 않기
사용자가 입력할 수 입력값은 언제든지 변조될 수 있음. 가령 프로그램이 특정한 값을 만들어서 사용자에게 전달했더라도, 사용자는 해당값을 사용하지 않고 새로운 입력값으로 변조할 수 있음. 유저가 입력할 수 있는 입력값은 변조되어도 안전해야 함.

### 3. 사용자 개입을 최소화하기
유저가 입력할 필요가 없는 값들은 전달받지 않아야 함. 서버에서만 사용되는 값은 세션 혹은 데이터베이스에서 조회하여 사용해야함.