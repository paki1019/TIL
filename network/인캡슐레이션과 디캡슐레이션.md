# 인캡슐레이션과 디캡슐레이션

상위 계층에서 하위 계층으로 데이터를 보내면 물리 계층에서 전기 신호 형태로 네트워크를 통해 신호를 보냄. 받는 쪽은 다시 하위 계층에서 상위 계층으로 데이터를 보냄. 이와 같이 데이터를 보내는 과정을 인캡슐레이션(Encapsulation), 데이터를 받는 과정을 디캡슐레이션(Decapsulation)이라고 부름.

현대 네트워크는 대부분 패킷 기반 네트워크. 패킷 네트워크는 데이터를 패킷이라는 작은 단위로 쪼개 보내는데 이런 기법으로 하나의 통신이 회선 전체를 점유하지 않고 동시에 여러 단말이 통신할 수 있도록 함. 데이터를 패킷으로 쪼개서 네트워크를 이용해 목적지로 보내고 받는 쪽에서는 패킷을 다시 큰 데이터 형태로 결합해 사용함.

애플리케이션에서 데이터를 데이터 플로 계층(1~4)으로 내려보내면서 패킷에 데이터를 넣을 수 있도록 분할하는데 이 과정을 인캡슐레이션이라고 부름. 네트워크 상황을 고려해 적절한 크기로 데이터를 쪼개고 4계층부터 네트워크 전송을 위한 정보를 헤더에 붙여 넣음.
헤더 정보는 4계층, 3계층, 2계층에서 각각 자신이 필요한 정보를 추가하는데 이 정보는 우리가 알아볼 수 있는 문자가 아닌 미리 정의된 비트 단위로 쓰여짐.

받는 쪽에서는 디캡슐레이션 과정을 수행함. 받은 전기 신호를 데이터 형태로 만들어 2계층으로 올려보냄. 2계층에서는 송신자가 작성한 2계층 헤더에 포함된 정보를 확인함. 2계층에 적힌 정보 중 목적지가 자신이 아니라면 자신에게 온 패킷이 아니므로 버림. 랜 카드가 이 역할을 담당함. 2계층에 적힌 정보의 목적지가 자신이 맞다면 2계층의 헤더 정보는 더 필요없으므로 벗겨내고 3계층으로 이 정보를 올려보내줌. 3계층에서는 3계층 헤더 정보를 확인해 자신에게 온 것이 맞는지 확인하고 맞으면 3계층 헤더 정보를 제거하고 4계층으로 보냄. 4계층도 3계층과 같은 과정을 거쳐 데이터를 애플리케이션에 올려보내줌.

- 인캡슐레이션, 디캡슐레이션 과정을 통해 데이터 전송
- 각 계층 헤더를 이용해 송신자 계층과 수신자 계층 간 논리적 통신

정리하면 실제 데이터는 상위 계층 -> 하위 계층, 하위 계층 -> 상위 계층으로 전달되고 헤더 정보는 각 계층끼리 전달됨.

데이터를 인캡슐레이션하는 과정에서 헤더에 넣는 정보는 각 프로토콜마다 각양각색임. 하지만 이런 복잡한 정보들에도 규칙이 있으며 두 가지 정보는 반드시 포함되어야 함.

1. 현재 계층에서 정의하는 정보
2. 상위 프로토콜 지시자

현재 계층에서 정의하는 정보는 앞서 다룬 OSI 7계층의 각 계층별 목적에 맞는 정보를 의미. 4계층의 목적은 큰 데이터를 잘 분할하고 받는 쪽에서는 잘 조립하는 것. 데이터에 순서를 정하고 받는 패킷의 순서가 맞는지, 빠진 패킷은 없는지 점검하는 역할이 중요하며 이 정보를 헤더에 적어 넣게 됨. TCP/IP의 4계층 프로토콜인 TCP에서는 시퀀스(Sequence), 애크(ACKnowledgement) 번호 필드로 이 데이터를 표현함. 3계층 헤더에서는 3계층에서 정의하는 논리적인 주소인 출발지, 도착지 IP 주소를 헤더에 적어 넣음. 2계층은 3계층처럼 출발지, 도착지의 MAC 주소 정보를 헤더에 넣음.

프로토콜 스택은 상위 계층으로 올라갈수록 종류가 많아짐. 3계층 프로토콜인 IP는 4계층에서 TCP, UDP로 나뉘고, 그보다 상위 계층에서는 FTP, HTTP, SMTP, POP3 등 더 다양한 프로토콜로 다시 나뉨.

인캡슐레이션 과정에서는 상위 프로토콜이 많아도 문제가 없지만 디캡슐레이션하는 목적지 쪽에서는 헤더에 아무 정보가 없으면 어떤 상위 프로토콜로 올려보내 주어야 할 지 결정할 수 없음. 이런 문제가 발생하지 않도록 인캡슐레이션하는 쪽에서는 헤더에 상위 프로토콜 지시자 정보를 포함해야함.

각 계층마다 이 상위 프로토콜 지시자를 가지고 있지만 이름이 다름. 4계층은은 포트 번호(Port Nubmer), 3계층은 프로토콜 번호(Protocol Number), 2계층은 이더 타입(Ether Type)이라고 부름. 착각하기 쉬운 점은 포트 번호는 4계층 헤더에 적힌 정보이지만 애플리케이션 계층에서 프로토콜 종류를 나타내주는 정보라는 것. 디캡슐레이션할 때 상위 프로토콜 지시자 정보를 이용해 어느 상위 계층 프로토콜로 보내야 할지 구분해야 하므로 동작하는 계층보다 한 계층 위에 정보가 적혀 있게 됨.

### MSS & MTU(데이터 크기 조절)

애플리케이션에서 데이터를 만들어 보낼 때 데이터 플로 계층에서 네트워크 상황에 맞게 데이터를 잘 쪼개 상대방에게 전달함. 네트워크에서 수용할 수 있는 크기를 역산정해 데이터가 4계층으로 내려올 떄 적절한 크기로 쪼개질 수 있도록 유도하는데 이 값을 MSS(Maximum Segment Size)라고 부름. 네트워크에서 한 번에 보낼 수 있는 데이터 크기를 MTU(Maximum Transmission Unit)라고 부르며 이더넷에서 수용할 수 있는 크기는 1,500 바이트. MTU와 MSS는 모두 데이터 크기를 지정하는 것이나 MTU값은 2계층의 데이터 값, MSS는 4계층에서 가질 수 있는 최대 데이터 값을 의미. 2계층에서 2계층 헤더들의 크기를 제외한 데이터 크기를 MTU 크기라고 부름. IP 헤더와 TCP 헤더의 표준 헤더 크기는 일반적으로 각각 20바이트이므로 일반 이더넷인 경우, MSS값을 1,460 바이트로 사용함.
